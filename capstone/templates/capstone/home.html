{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  </head>

  <link href="{% static 'css/home.css' %}" rel="stylesheet">
  <title>Main Page</title>
      <body>
    <nav class="navbar fixed-top flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="{% url 'home' %}">Swapstone</a>
  <!-- <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search"> -->
  <ul class="navbar-nav px-3">
    <li class="nav-item text-nowrap">
      <a class="nav-link" href="{% url 'logout' %}">Log out</a>
    </li>
  </ul>
</nav>

<div class="container-fluid">
  <div class="row">
    <nav class="col-md-2 d-none d-md-block bg-light sidebar">
      <div class="sidebar-sticky">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#">
              <span data-feather="home"></span>
              Home <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'csv' %}">
              <span data-feather="file"></span>
              Load CSV File
            </a>
          </li>
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Saved layouts</span>
          <a class="d-flex align-items-center text-muted" href="#" aria-label="Add a new report">
            <span data-feather="plus-circle"></span>
          </a>
        </h6>
        <ul class="nav flex-column mb-2">
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="file-text"></span>
              Saved Data 1
            </a>
          </li>
        </ul>
        <button class="save-btn btn-lg btn-success btn-block">Save</button>
      </div>
    </nav>
    <main role="main" class="col-md-8 ml-sm-auto col-lg-10 px-0">
      <div class = "map" id = "main">
        <div id = "tools">
          <input type="checkbox" id="editorMode"><span class="checkboxtext font-size:1pt">Editor Mode</span></input>
        </div>
        <div id = "allocation-container">
        </div>
        <div id = "selection-container">
          <h2>Selected Booth:</h2>
          <p id = "selected-booth-name"></p>
        </div>
      </div>
    </main>
    <nav class="col-md-2 d-none d-md-block bg-light rightbar">
      <div class="rightbar-sticky">
        <ul class="list-of-booths flex-column">
          <li class="booth-item">
            <a class="booth-link">Booth #1</a>
          </li>
        </ul>
        <button class="allocate-btn btn-lg btn-dark btn-block">Allocate</button>
      </div>
    </nav>
  </div>
</div>
  <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.js"></script>
  <script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
</body>

</html>
<script src="http://d3js.org/d3.v5.js"></script>
<script>
 // initialize constant
 const MAX_WIDTH = 830;
  const MAX_HEIGHT = 637;
  
  const ratiox = MAX_WIDTH / 1000;
  const ratioy = MAX_HEIGHT / 1000;

  //for zoom functionality
  const MAX_TRANSLATE_X = MAX_WIDTH / 2;
  const MIN_TRANSLATE_X = -MAX_TRANSLATE_X;
  const MAX_TRANSLATE_Y = MAX_HEIGHT / 2;
  const MIN_TRANSLATE_Y = -MAX_TRANSLATE_Y;
  
  // dummy data
  // maybe data = function() -> import data -> json preferred
  const data = [{ "x" : 360, "y" : 360, "width" : 80, "height" : 80, "group" : "C2", "rotate" :0},
  { "x" : 440, "y" : 400, "width" : 40, "height" : 40, "group": "C1", "rotate" : 0},
  { "x" : 480, "y" : 400, "width" : 40, "height" : 40, "group" : "C10", "rotate" : 0},
  { "x" : 520, "y" : 400, "width" : 40, "height" : 40, "group" : "C3", "rotate" : 0},
  { "x" : 400, "y" : 450, "width" : 40, "height" : 40, "group" : "C4", "rotate" : 0},
  { "x" : 400, "y" : 490, "width" : 40, "height" : 40, "group" : "C28", "rotate" : 0}];


  var img = new Image();

  img.onload = function (){
    var h = img.height;
    var w = img.width;

    console.log(h, w);
  }

  img.src = "{% static 'images/scratch.jpg' %}"
  // inititalizing the axis and scale
  var xscale = d3.scaleLinear()
          .domain([-1, MAX_WIDTH + 1])
          .range([0, MAX_WIDTH - 5])
          ;
  
  var yscale = d3.scaleLinear()
          .domain([-1, MAX_HEIGHT + 1])
          .range([MAX_HEIGHT - 5, 0])
          ;
  
  // .tickSize and ticks create the grid
  var x_axis = d3.axisBottom(xscale)
          .tickSize(MAX_HEIGHT - 5)
          .ticks(40)
          ;
  
  var y_axis = d3.axisLeft(yscale)
          .tickSize(-MAX_WIDTH + 5)
          .ticks(40)
          ;

  // create svg canvas
  var svg = d3.select("#main")
              .select("#allocation-container")
              .append("svg")
              .attr("id", "allocation")
              .attr("width", MAX_WIDTH)
              .attr("height", MAX_HEIGHT)
              // .append("g")
    
              ;

  // var zoom_rect = svg.append("g")
  //                     .append("rect")
  //                     .attr("id", "zoom-rect")
  //                     .attr("width", MAX_WIDTH)
  //                     .attr("height", MAX_HEIGHT)
  //                     .attr("fill", "none")
  //                     ;

 
            
  // var svg_zoom = svg.append("g");

  // include zoom and drag functionality
  var zoom = d3.zoom()
    .scaleExtent([1, 2])
    // .translateExtent([
    //   [MIN_TRANSLATE_X, MIN_TRANSLATE_Y],
    //   [MAX_TRANSLATE_X, MAX_TRANSLATE_Y]
    // ])
    .translateExtent([
      [0, 0],
      [MAX_WIDTH, MAX_HEIGHT]
    ])
    // .constrain(function (transform, extent, translateExtent) {
    //   var cx = transform.invertX((extent[1][0] - extent[0][0]) / 2),
    //     cy = transform.invertY((extent[1][1] - extent[0][1]) / 2),
    //     dcx0 = Math.min(0, cx - translateExtent[0][0]),
    //     dcx1 = Math.max(0, cx - translateExtent[1][0]),
    //     dcy0 = Math.min(0, cy - translateExtent[0][1]),
    //     dcy1 = Math.max(0, cy - translateExtent[1][1]);
    //   return transform.translate(
    //     Math.min(0, dcx0) || Math.max(0, dcx1),
    //     Math.min(0, dcy0) || Math.max(0, dcy1)
    //   );
    // })
    .on("zoom", zoomed)

  function zoomed() {
          // svg.attr("transform", d3.event.transform);
      gX.call(x_axis.scale(d3.event.transform.rescaleX(xscale)));
      gY.call(y_axis.scale(d3.event.transform.rescaleY(yscale)));
      image.attr("transform", d3.event.transform);
      booth.attr("transform", d3.event.transform);
      text.attr("transform", d3.event.transform);
      refresh();
  }

  svg.call(zoom);

//  include drag booth functionality
  function dragstarted(d) {
    d3.select(this).attr("stroke", "black");
  }

  function dragged(d) {
    d3.select(this).raise().attr("x", d.x = d3.event.x).attr("y", d.y = d3.event.y);
  }

  function dragended(d) {
    d3.select(this).attr("stroke", null);
  }

  var drag = d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended);;

  var image = svg.append('image')
                // .attr('width', MAX_WIDTH - 5)
                // .attr('height', MAX_HEIGHT - 5)
                .attr('x', 0)
                .attr('y', 0)
                .attr("href", "{% static 'images/scratch.jpg' %}")
                ;

  console.log(image.clientWidth);

  var gX =  svg.append("g")
        .attr("id", "x-axis")
        .call(x_axis)
        ;

  var gY = svg.append("g")
        .attr("id", "y-axis")
        .call(y_axis)
        ;

  var booth = svg.selectAll('.dot')
                .data(data)
                .enter()
                .append("g")
                
            booth.append("rect")
                .attr("class", "booth")
                .attr("id", function(d){
                  return 'group' + d.group;
                })
                .attr("x", function(d){
                  // d.x = xscale(d.x);
                  return (d.x) * ratiox;
                })
                .attr("y", function(d){
                  // d.y = yscale(d.y);
                  return (d.y) * ratioy;
                })
                .attr("height", function(d){
                  return d.height * ratioy;
                })
                .attr("width", function(d){
                  return d.width * ratiox;
                })
                // .attr("transform", "translate(0," + height + ")")
                // .attr("transform", function(d){
                //   return "rotate(" + d.rotate + ")";
                // })
                .call(drag)
                .on("click", function(d){
                  $("#selected-booth-name").text(d.group);
                })
                ;
                


    var text = svg.selectAll(".dot")
                  .data(data)
                  .enter()
                  .append("text")
                  .attr("class", "name")
                  .attr('text-anchor', 'middle')
                  .style("font-size", "14px")
                  .attr("x", function(d){
                    // d.x = xscale(d.x);
                    return (d.x + d.width / 2) * ratiox;
                  })
                  .attr("y", function(d){
                    // d.y = yscale(d.y);
                    return (d.y + d.height / 2) * ratioy;
                  })
                  // .attr("transform", function(d){
                  //   return "rotate(" + d.rotate + ")";
                  // })
                  .text(function(d){
                    return d.group;
                  })
                  ;



    svg.call(d3.zoom().on("zoom", zoomed));
        
    function refresh(){
      // svg.selectAll("text")
      //             .attr("x", function(d){
      //               // d.x = xscale(d.x);
      //               // return d.x;
      //               return (d.x + d.width / 2) * ratiox;
      //             })
      //             .attr("y", function(d){
      //               // d.y = yscale(d.y);
      //               // return d.y;
      //               return (d.y + d.height / 2) * ratioy;
      //             })
      //             // .attr("transform", function(d){
      //             //   return "rotate(" + d.rotate + ")";
      //             // })
      //             .text(function(d){
      //               return d.group;
      //             })
      //             ;
    }
    // window.onload(){

    // }
        
</script>