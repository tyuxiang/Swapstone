{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
      #tools .active{
        /* color: white;
        background-color: black;
        stroke: blue;
        outline-color: blue; */
        border-width: 2pt;
        border-color: lightblue;
      }

      .booth-item-containers form{
        display: table;
      }

      .booth-item-containers p{
        display: table-row;
      }

      .booth-item-containers label{
        display: table-cell;
      }

      .booth-item-containers input{
        display: table-cell;
      }

    </style>
  </head>

  <link href="{% static 'css/home.css' %}" rel="stylesheet">
  <title>Main Page</title>
      <body> 
    <nav class="navbar fixed-top flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="{% url 'home' %}">Swapstone</a>
  <!-- <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search"> -->
  <ul class="navbar-nav px-3">
    <li class="nav-item text-nowrap">
      <a class="nav-link" href="{% url 'logout' %}">Log out</a>
    </li>
  </ul>
</nav>

<div class="container-fluid">
  <div class="row">
    <nav class="col-md-2 d-none d-md-block bg-light sidebar">
      <div class="sidebar-sticky">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#">
              <span data-feather="home"></span>
              Home <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'csv' %}">
              <span data-feather="file"></span>
              Load CSV File
            </a>
          </li>
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Saved layouts</span>
          <a class="d-flex align-items-center text-muted" href="#" aria-label="Add a new report">
            <span data-feather="plus-circle"></span>
          </a>
        </h6>
        <ul class="nav flex-column mb-2">
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="file-text"></span>
              Saved Data 1
            </a>
          </li>
        </ul>
        <button class="save-btn btn-lg btn-success btn-block">Save</button>
      </div>
    </nav>
    <main role="main" class="col-md-8 ml-sm-auto col-lg-10 px-0">
      <div class = "map" id = "main">
        <div id = "tools">
          <button type="button" id="dragbooth-button" onclick = "dragBoothButtonHandler()">Drag Booth</button>
          <button type="button" id="zoom-button" onclick = "zoomButtonHandler()">Zoom </button>
          <button type="button" id="undo-button" onclick = "undoButtonHandler()">Undo</button>
        </div>
        <div id = "allocation-container">
        </div>
        <div id = "selection-container">
          <h2 id = "selected-booth-name">Selected Booth: </h2>
          <p>
            <label>X : </label><input type = "text" id = "input-x">
            <label>Y : </label><input type = "text" id = "input-y">
            <label>Height : </label><input type = "text" id = "input-height">
            <label>Width : </label><input type = "text" id = "input-width">  
          </p>
          <button id = "remove-button">Remove</button>
        </div>
      </div>
    </main>
    <nav class="col-md-2 d-none d-md-block bg-light rightbar">
      <div class="rightbar-sticky">
        <ul class="list-of-booths flex-column" id = "booth-list">
          <!-- <li class="booth-item">
            <a class="booth-link">Booth #1</a>
          </li> -->
        </ul>
        <button class="allocate-btn btn-lg btn-dark btn-block">Allocate</button>
      </div>
    </nav>
  </div>
</div>
  <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.js"></script>
  <script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
</body>

</html>
<script src="http://d3js.org/d3.v5.js"></script>
<script>
  // initialize constant
  var img = new Image();
  img.src = "{% static 'images/scratch.jpg' %}"

  const MAX_WIDTH = img.width;
  const MAX_HEIGHT = img.height;
  
  const ratiox = MAX_WIDTH / 1000;
  const ratioy = MAX_HEIGHT / 1000;

  //for zoom functionality
  const MAX_TRANSLATE_X = MAX_WIDTH / 2;
  const MIN_TRANSLATE_X = -MAX_TRANSLATE_X;
  const MAX_TRANSLATE_Y = MAX_HEIGHT / 2;
  const MIN_TRANSLATE_Y = -MAX_TRANSLATE_Y;
  
  var data = [];

  var preData = ( "{{ booth|escapejs }}" );
  var parseData = JSON.parse(preData)
  for (var i = 0; i < parseData.length ; i++){
    parseData[i].fields.position_x = parseFloat(parseData[i].fields.position_x)
    parseData[i].fields.position_y = parseFloat(parseData[i].fields.position_y)
    parseData[i].fields.length_pixel = parseFloat(parseData[i].fields.length_pixel)
    parseData[i].fields.width_pixel = parseFloat(parseData[i].fields.width_pixel)
    parseData[i].fields.rotation = parseFloat(parseData[i].fields.rotation)
    parseData[i].fields.length = parseFloat(parseData[i].fields.length)
    parseData[i].fields.width = parseFloat(parseData[i].fields.width)
    parseData[i].fields.area = parseFloat(parseData[i].fields.area)
    data.push(parseData[i].fields)

    console.log(parseData[i].fields.width)
    // data.push(preData[i].fields)
    // data.push({"project_id" : parseData[i]["fields"]["project_id"],
    //             "position_x" : parseInt(parseData[i]["fields"]["position_x"]),
    //             "position_y" : parseInt(parseData[i]["fields"]["position_y"]),
    //             "height" : parseInt(parseData[i]["fields"]["length_pixel"]),
    //             "width" : parseInt(parseData[i]["fields"]["width_pixel"]),
    //             "group" : parseData[i]["fields"]["project_name"],
    //             "rotate" : parseInt(parseData[i]["fields"]["rotation"]),
    //             })
  }
  console.log(data);

  // maybe data = function() -> import data -> json preferred
  // var data = [{"id" :  0, "x" : 360, "y" : 360, "width" : 80, "height" : 80, "group" : "C2", "rotate" :90},
  // {"id" :  1, "x" : 440, "y" : 400, "width" : 40, "height" : 40, "group": "C1", "rotate" : 20},
  // {"id" :  2, "x" : 480, "y" : 400, "width" : 40, "height" : 40, "group" : "C10", "rotate" : 30},
  // {"id" :  3, "x" : 520, "y" : 400, "width" : 40, "height" : 40, "group" : "C3", "rotate" : 40},
  // {"id" :  4, "x" : 400, "y" : 450, "width" : 40, "height" : 40, "group" : "C4", "rotate" : 50},
  // {"id" :  5, "x" : 400, "y" : 490, "width" : 40, "height" : 40, "group" : "C28", "rotate" : 0},
  // {"id" :  6, "x" : -1, "y" : -1, "width" : 80, "height" : 70, "group" : "C14", "rotate" : 0},
  // {"id" :  7, "x" : -1, "y" : -1, "width" : 80, "height" : 80, "group" : "C21", "rotate" : 0}];

  var canDragBooth;
  var curBoothID;
  
  var currentZoomScale;

  // function initialize(){
  //   // c
  //   data.forEach(function(booth){
  //     booth.position_x = booth.position_x * ratiox;
  //     booth.position_y = booth.position_y * ratioy;
  //     booth.length_pixel = booth.length_pixel * ratioy;
  //     booth.width_pixel = booth.width_pixel * ratiox;

  //   })
  // }

  function checkValidXY(i){
    if (data[i].position_x < 0){
      return false;
    }
    if (data[i].position_y < 0){
      return false;
    }
    return true;
  }

  // initialize();

  // inititalizing the axis and scale
  var xscale = d3.scaleLinear()
          .domain([-1, MAX_WIDTH])  // The domain is the complete set of values
          .range([0, MAX_WIDTH])    // The range is the set of resulting function
          ;
  
  var yscale = d3.scaleLinear()
          .domain([-1, MAX_HEIGHT])
          .range([MAX_HEIGHT, 0])
          ;
  
  // .tickSize and ticks create the grid
  var x_axis = d3.axisBottom(xscale)
          // .tickSize(MAX_HEIGHT)
          // .ticks(40)
          ;
  
  var y_axis = d3.axisLeft(yscale)
          // .tickSize(-MAX_WIDTH)
          // .ticks(40)
          ;

  // create svg canvas
  var svg = d3.select("#main")
              .select("#allocation-container")
              .append("svg")
              .attr("id", "allocation")
              .attr("width", MAX_WIDTH)
              .attr("height", MAX_HEIGHT)
              // .append("g")
              ;

  svg.append("defs")
      .append("clipPath")
      .attr("id", "clip")
      .append("rect")
      .attr("height", MAX_HEIGHT)
      .attr("width", MAX_WIDTH)
      .attr("fill", "none")
      ;

  // include zoom and drag functionality
  var zoom = d3.zoom()
      .scaleExtent([1, 2])
      .translateExtent([
        [0, 0],
        [MAX_WIDTH, MAX_HEIGHT]
      ])
      .on("zoom", function(d){
        // gX.call(x_axis.scale(d3.event.transform.rescaleX(xscale)));
        // gY.call(y_axis.scale(d3.event.transform.rescaleY(yscale)));
        image.attr("transform", d3.event.transform);
        // .attr("clip-path","url(#clip)");
        booth.attr("transform", d3.event.transform);
        // .attr("clip-path","url(#clip)");
        // .attr("clip-path","url(#clip)");
      })
      ;
  
//  include drag booth functionality
  var drag = d3.drag()
      .on("start", function(){
        d3.select(this).attr("stroke", "red");
      })
      .on("drag", function(d){
        d3.select(this).raise()
          .attr("transform", function(d){
            return "rotate(" + d.rotation + " " + (d.position_x  + d.width_pixel / 2) + " " + (d.position_y + d.length_pixel / 2) +")";
          })
          .attr("x", function(d){
              console.log(d.position_x, d3.event.x)
              d.position_x = Math.max(0, Math.min(MAX_WIDTH - d.width_pixel, d3.event.x));
              // return d.position_x;
              return d.position_x;
            })
          .attr("y", function(d){
              d.position_y = Math.max(0, Math.min(MAX_HEIGHT - d.length_pixel, d3.event.y));
              return d.position_y;
            });
          
          $("#selected-booth-name").text("Selected Booth: " + d.project_name);
          $("#input-x").val(Math.round(d.position_x));
          $("#input-y").val(Math.round(d.position_y));
          $("#input-width").val(Math.round(d.width_pixel));
          $("#input-height").val(Math.round(d.length_pixel));

          svg.select("#booth-text-id-"+ d.project_id)
              .attr("transform", function(d){
                return "rotate(" + d.rotation + " " + (d.position_x  + d.width_pixel / 2) + " " + (d.position_y + d.length_pixel / 2) +")";
              })
              .attr("x", function(d){
                return d.position_x + (d.width_pixel / 2);
              })
              .attr("y", function(d){
                return d.position_y + (d.length_pixel / 2);
              })
              ;
      })
      .on("end", function(d){
        d3.select(this).attr("stroke", null);
        curBoothID = d.project_id;
      });

  function dragBoothButtonHandler(){
    $("#dragbooth-button").toggleClass("active");
    canDragBooth = true;
  }

  function zoomButtonHandler(){
    $("#zoom-button").toggleClass("active");
  }

  function undoButtonHandler(){
    $("#undo-button").toggleClass("active");
  }

  // change booth attributes by keying the value
  $("#input-x").keyup(function(){
    var value = $(this).val();
    svg.select("#booth-id-" + curBoothID)
        .attr("x", function(d){
          d.position_x = parseFloat(value);
          return d.position_x;
        });
    svg.select("#booth-text-id-" + curBoothID)
        .attr("x", function(d){
          return d.position_x + d.width_pixel / 2;
        });
  }).keyup();

  $("#input-y").keyup(function(){
    var value = $(this).val();
    svg.select("#booth-id-" + curBoothID)
        .attr("y", function(d){
          d.position_y = parseFloat(value);
          return d.position_y;
        });
    svg.select("#booth-text-id-" + curBoothID)
        .attr("y", function(d){
          return d.position_y + d.length_pixel / 2;
        });
  }).keyup();

  $("#input-height").keyup(function(){
    var value = $(this).val();
    svg.select("#booth-id-" + curBoothID)
        .attr("height", function(d){
          d.length_pixel = parseInt(value);
          return d.length_pixel;
        });
    svg.select("#booth-text-id-" + curBoothID)
        .attr("y", function(d){
          return d.position_y + d.length_pixel / 2;
        });
  }).keyup();

  $("#input-width").keyup(function(){
    var value = $(this).val();
    svg.select("#booth-id-" + curBoothID)
        .attr("width", function(d){
          d.width_pixel = parseInt(value);
          return d.width_pixel;
        });
    svg.select("#booth-text-id-" + curBoothID)
        .attr("x", function(d){
          return d.position_x + d.width_pixel / 2;
        });
  }).keyup();

  $("#remove-button").click(function(){
    booth.select('#booth-id-' + curBoothID)
        .attr("visibility", "hidden");
        booth.select('#booth-text-id-' + curBoothID)
        .attr("visibility", "hidden");
      $("#booth-list").append('<li id = "booth-item-' + curBoothID + '"><a class = "booth-link">Booth #' + curBoothID + '</a></li>');
      $("#booth-list").append('<form id = "booth-item-container-' + curBoothID + '" class = "booth-item-containers">  </form>');

      $('#booth-item-container-' + curBoothID).append('<button type = "button" id = "booth-item-button-' + curBoothID + '"> Add Booth </button>');
      $('#booth-item-button-' + curBoothID).click(function(){
        // var thisID = $(this).attr("id").slice(18);
        booth.select('#booth-id-' + curBoothID)
        .attr("visibility", "visible");

        booth.select('#booth-text-id-' + curBoothID)
        .attr("visibility", "visible");
        
        $('#booth-item-container-'+ curBoothID).remove();
        $('#booth-item-'+ curBoothID).remove();
      })

      $('#booth-item-container-' + curBoothID).hide();
      $('#booth-item-'+ curBoothID).click(function(i) {
        // var thisID = $(this).attr("id");
        $('#booth-item-container-' + curBoothID).toggle();
      })
  })

  // image
  var image = svg.append('image')
                // .attr('width', MAX_WIDTH - 5)
                // .attr('height', MAX_HEIGHT - 5)
                .attr("id", "map-layout")
                .attr("clip-path","url(#clip)")
                .attr('x', 0)
                .attr('y', 0)
                .attr("href", "{% static 'images/scratch.jpg' %}")
                ;
  
  // axis handler
  var gX =  svg.append("g")
        .attr("id", "x-axis")
        .call(x_axis)
        ;

  var gY = svg.append("g")
        .attr("id", "y-axis")
        .call(y_axis)
        ;

  var booth = svg.selectAll('.booth')
                .data(data)
                .enter()
                .append("g")
                .attr("class", function(d){
                  return "booth-containers";
                })
                .attr("id", function(d){
                  return "booth-container-id-" + d.project_id;
                })

    booth.append("text")
            .attr("class", "name")
            .attr("id", function(d){
              return "booth-text-id-" + d.project_id;
            })
            .attr('text-anchor', 'middle')
            .style("font-size", function(){
              return "11px";
            })
            .attr("x", function(d){
              return d.position_x + (d.width_pixel / 2);
            })
            .attr("y", function(d){
              return d.position_y + (d.length_pixel / 2);
            })
            .attr("transform", function(d){
              return "rotate(" + d.rotation + " " + (d.position_x  + d.width_pixel / 2) + " " + (d.position_y + d.length_pixel / 2) +")";
            })
            .text(function(d){
              return d.project_name;
            })
            .attr("visibility", function(d){
              if (d.position_x < 0){
                return "hidden"
              }
            })
            ;        
            
    booth.append("rect")
          .attr("class", "booth")
          .attr("id", function(d){
            return 'booth-id-' + d.project_id;
          })
          .attr("x", function(d, i){
            if(d.position_x > 0){
              return d.position_x;
            }
          })
          .attr("y", function(d){
            if(d.position_y > 0){
              return d.position_y;
            }
          })
          .attr("height", function(d){
            return d.length_pixel;
          })
          .attr("width", function(d){
            return d.width_pixel;
          })
          .attr("clip-path","url(#clip)")
          .attr("transform", function(d){
            return "rotate(" + d.rotation + " " + (d.position_x  + d.width_pixel / 2) + " " + (d.position_y + d.length_pixel / 2) +")";
          })
          .attr("visibility", function(d){
            if (d.position_x < 0){
              return "hidden"
            }
          })
          .call(drag)
          .on("click", function(d){
            curBoothID = d.project_id;
            // curBoothNameID =
            $("#selected-booth-name").text("Selected Booth: " + d.project_name);
            $("#input-x").val(Math.round(d.position_x));
            $("#input-y").val(Math.round(d.position_y));
            $("#input-width").val(Math.round(d.width_pixel));
            $("#input-height").val(Math.round(d.length_pixel));
          })
          ;

    svg.call(zoom);


    // <ul class="list-of-booths flex-column" id = "booth-list">
    //       <li class="booth-item">
    //         <a class="booth-link">Booth #1</a>


    // can change this with angular / react / vue components
    // $("#menu").append('<li><a href="#">New list item</a></li>');
    for (var i = 0; i < data.length; i++){
      if (!checkValidXY(i)){
        // $("#booth-container-id-" + data[i].id).hide()
        // $("#booth-text-id-" + data[i].id).hide()
      //  null || data[i].y == null || data[i].height == null || data[i].width == null){
        $("#booth-list").append('<li id = "booth-item-' + data[i].project_id + '"><a class = "booth-link">Booth #' + data[i].group + '</a></li>');
        $("#booth-list").append('<form id = "booth-item-container-' + data[i].project_id + '" class = "booth-item-containers">  </form>');

        // $('#booth-item-container-' + data[i].id).append('<p><label>X : </label><input type = "text" id = "booth-item-input-x-' + data[i].id + '"></p>');
        // $('#booth-item-input-x-' + data[i].id).val(-1); 
        // console.log($('#booth-item-input-x-' + data[i].id).val());

        // $('#booth-item-container-' + data[i].id).append('<p><label>Y : </label><input type = "text" id = "booth-item-input-y-' + data[i].id + '"></p>');
        // $('#booth-item-input-y-' + data[i].id).val(-1); 

        // $('#booth-item-container-' + data[i].id).append('<p><label>Height : </label><input type = "text" id = "booth-item-input-height-' + data[i].id + '"></p>');
        // $('#booth-item-input-height-' + data[i].id).val(Math.round(data[i].height)); 

        // $('#booth-item-container-' + data[i].id).append('<p><label>Width : </label><input type = "text" id = "booth-item-input-width-' + data[i].id + '"></p>');
        // $('#booth-item-input-width-' + data[i].id).val(Math.round(data[i].width)); 
        
        $('#booth-item-container-' + data[i].project_id).append('<button type = "button" id = "booth-item-button-' + data[i].project_id + '"> Add Booth </button>');
        $('#booth-item-button-' + data[i].project_id).click(function(){
          var thisID = $(this).attr("id").slice(18);
          // data[thisID].x =  parseInt($('#booth-item-input-x-' + data[thisID].id).val());
          // data[thisID].y =  parseInt($('#booth-item-input-y-' + data[thisID].id).val());
          // data[thisID].height =  parseInt($('#booth-item-input-height-' + data[thisID].id).val());
          // data[thisID].width =  parseInt($('#booth-item-input-width-' + data[thisID].id).val());
          // $('#booth-container-id-' + thisID).append('<rect x = "100" y = "100" height = "100" width= "100" class = "booth" id = booth-id-' + thisID + '></rect>');
          booth.select('#booth-id-' + thisID)
          // .attr("x", data[thisID].x)
          // .attr("y", data[thisID].y)
          // .attr("height", data[thisID].height)
          // .attr("width", data[thisID].width)
          .attr("visibility", "visible");

          booth.select('#booth-text-id-' + thisID)
          .attr("visibility", "visible");
         
          $('#booth-item-container-'+ thisID).remove();
          $('#booth-item-'+ thisID).remove();
        })

        $(".booth-item-containers").hide();
        $('#booth-item-'+ data[i].project_id).click(function(i) {
          var thisID = $(this).attr("id");
          $('#booth-item-container-' + thisID.slice(11)).toggle();
        })

      }
    }



    console.log(data);
</script>